<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cardGGaduekMainService.totalbenefit.mapper.TotalBenefitMapper">
    <select id="getCategoryBenefits" resultType="org.cardGGaduekMainService.totalbenefit.dto.CategoryBenefitDTO">
        SELECT
        t.transaction_category_code AS category,
        CAST(
        COALESCE(SUM(
        CASE
        WHEN sb.value_type = 'PERCENT'
        THEN ROUND(t.amount * IFNULL(sb.rate_value, 0) / 100, 0)
        WHEN sb.value_type = 'AMOUNT'
        THEN IFNULL(sb.amount_value, 0)
        ELSE 0
        END
        ), 0) AS UNSIGNED
        ) AS amount
        FROM `transaction` t
        JOIN card c          ON c.id = t.card_id
        JOIN card_product cp ON cp.id = c.card_product_id
        LEFT JOIN store_benefit sb
        ON sb.card_product_id = cp.id
        AND sb.store_category   = t.store_category
        WHERE t.transaction_status = 'APPROVED'
        AND t.member_id = #{memberId}
        AND t.`date` >= STR_TO_DATE(CONCAT(#{yearMonth}, '-01'), '%Y-%m-%d')
        AND t.`date` &lt; DATE_ADD(STR_TO_DATE(CONCAT(#{yearMonth}, '-01'), '%Y-%m-%d'), INTERVAL 1 MONTH)
        GROUP BY t.transaction_category_code
    </select>
</mapper>

