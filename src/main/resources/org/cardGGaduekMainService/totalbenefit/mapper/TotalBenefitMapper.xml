<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.cardGGaduekMainService.totalbenefit.mapper.TotalBenefitMapper">

    <select id="getCategoryBenefits" resultType="org.cardGGaduekMainService.totalbenefit.dto.CategoryBenefitDTO">
        SELECT
            t.transaction_category_code AS category,
            COALESCE(SUM(
                             CASE
                                 WHEN sb.value_type = 'PERCENT' THEN ROUND(t.amount * IFNULL(sb.rate_value, 0) / 100, 0)
                                 WHEN sb.value_type = 'AMOUNT' THEN IFNULL(sb.amount_value, 0)
                                 ELSE 0
                                 END
                     ), 0) AS amount
        FROM transaction t
                 JOIN card c ON t.card_id = c.id
                 JOIN card_product cp ON c.card_product_id = cp.id
                 LEFT JOIN store_benefit sb
                           ON sb.card_product_id = cp.id
                               AND sb.store_category = t.transaction_category_code
        WHERE t.transaction_status = 'APPROVED'
          AND c.member_id = #{memberId}
          AND DATE_FORMAT(t.date, '%Y-%m') = #{yearMonth}
        GROUP BY t.transaction_category_code
    </select>

</mapper>

        <!--        ðŸ”„ ì¿¼ë¦¬ ì‹¤í–‰ íë¦„:-->
        <!--        1ë²ˆ íšŒì›, 2025ë…„ 7ì›” ì¡°íšŒ ìš”ì²­-->
        <!--        â†’ transaction í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ì¡°ê±´ ê±°ëž˜ë“¤ ì°¾ê¸°-->
        <!--        â†’ card í…Œì´ë¸”ê³¼ JOIN (ì–´ë–¤ ì¹´ë“œë¡œ ê²°ì œí–ˆëŠ”ì§€)-->
        <!--        â†’ card_product í…Œì´ë¸”ê³¼ JOIN (ì¹´ë“œ ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°)-->
        <!--        â†’ store_benefit í…Œì´ë¸”ê³¼ LEFT JOIN (í˜œíƒ ì„¤ì • í™•ì¸)-->
        <!--        â†’ ê° ê±°ëž˜ë³„ë¡œ í˜œíƒ ê³„ì‚°-->
        <!--        â†’ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í•‘í•´ì„œ í•©ê³„-->
        <!--        â†’ ìµœì¢… ê²°ê³¼ ë°˜í™˜-->
        <!--        ðŸ“Š ì‹¤ì œ ë°ì´í„° ì²˜ë¦¬ íë¦„:-->
        <!--        ìŠ¤íƒ€ë²…ìŠ¤ 4,800ì› ê±°ëž˜-->
        <!--        â†’ ì¹´ë“œ ID 1ë²ˆìœ¼ë¡œ ê²°ì œ-->
        <!--        â†’ ì¹´ë“œ ìƒí’ˆ ì •ë³´ ì°¾ê¸°-->
        <!--        â†’ COFFEE_SHOP ì¹´í…Œê³ ë¦¬ í˜œíƒ ìžˆë‚˜? (ìžˆìŒ)-->
        <!--        â†’ 4,800 Ã— 5% = 240ì› í˜œíƒ ê³„ì‚°-->
        <!--        ì˜¬ë¦¬ë¸Œì˜ 2,700ì› ê±°ëž˜-->
        <!--        â†’ ì¹´ë“œ ID 1ë²ˆìœ¼ë¡œ ê²°ì œ-->
        <!--        â†’ ì¹´ë“œ ìƒí’ˆ ì •ë³´ ì°¾ê¸°-->
        <!--        â†’ SHOPPING ì¹´í…Œê³ ë¦¬ í˜œíƒ ìžˆë‚˜? (ì—†ìŒ)-->
        <!--        â†’ 0ì› í˜œíƒ ê³„ì‚°-->
        <!--        ì¹´í…Œê³ ë¦¬ë³„ í•©ê³„-->
        <!--        â†’ COFFEE_SHOP: ì´ 11,520ì›-->
        <!--        â†’ SHOPPING: ì´ 0ì›-->
        <!--        â†’ ìµœì¢… ì‘ë‹µ ìƒì„±-->